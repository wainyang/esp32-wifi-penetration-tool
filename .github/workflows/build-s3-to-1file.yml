name: Build S3 Firmware

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:release-v5.1

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Fix Config
      run: |
        # 使用最稳妥的命令修改依赖，不再重写文件，只做追加
        sed -i 's/REQUIRES/REQUIRES esp_wifi esp_event lwip esp_http_server/g' components/wifi_controller/CMakeLists.txt || true
        sed -i 's/REQUIRES/REQUIRES esp_wifi esp_event lwip esp_http_server/g' main/CMakeLists.txt || true

    - name: Compile
      shell: bash
      run: |
        . $IDF_PATH/export.sh
        idf.py set-target esp32s3
        idf.py build

    - name: Merge
      shell: bash
      run: |
        . $IDF_PATH/export.sh
        # 使用官方合并命令，直接生成单一 bin
        esptool.py --chip esp32s3 merge_bin -o build/merged-firmware.bin --flash_mode dio --flash_size 4MB 0x0 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/*.bin

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: esp32-s3-firmware
        path: build/merged-firmware.bin
